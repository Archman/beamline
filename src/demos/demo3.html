

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Example 3 &mdash; beamline 1.3.6 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="beamline 1.3.6 documentation" href="../../index.html"/>
        <link rel="up" title="Examples and Demonstrations" href="../demo.html"/>
        <link rel="next" title="Example 4" href="demo4.html"/>
        <link rel="prev" title="Example 2" href="demo2.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> beamline
          

          
          </a>

          
            
            
              <div class="version">
                1.3.6
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deploy.html">Deployment</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../demo.html">Examples and Demonstrations</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="demo1.html">Example 1 (keywords: lattice visualization)</a></li>
<li class="toctree-l2"><a class="reference internal" href="demo2.html">Example 2 (keywords: online modeling)</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Example 3 (keywords: matching, FEL)</a></li>
<li class="toctree-l2"><a class="reference internal" href="demo4.html">Example 4 (Keywords: CLI, file conversion)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../apidoc.html">API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">beamline</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../demo.html">Examples and Demonstrations</a> &raquo;</li>
      
    <li>Example 3</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="example-3">
<h1>Example 3<a class="headerlink" href="#example-3" title="Permalink to this headline">Â¶</a></h1>
<p>Lattice/Twiss matching by using <code class="docutils literal"><span class="pre">matchutils</span></code> module of <code class="docutils literal"><span class="pre">beamline</span></code>
package for free-electron laser facility.</p>
<p>Module <code class="docutils literal"><span class="pre">matchutils</span></code> provides classes/functions to handle issues about
numerical simulation of free-electron laser (FEL),
including Twiss matching, to optimize an FEL, at the simulation stage.</p>
<p>In this example, we will tune the FODO lattice of an high-gain harmonic
generation (HGHG) FEL, to figure out the best Twiss parameters when the
electron beam enters into the undulator line, such matched Twiss parameter
could be used as the lattice matching goal of an matching application.</p>
<p>Here is the code for demostration:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">beamline</span> <span class="kn">import</span> <span class="n">parseLattice</span><span class="p">,</span> <span class="n">ParseParams</span><span class="p">,</span> <span class="n">BeamMatch</span><span class="p">,</span> <span class="n">FELSimulator</span>


<span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="n">testParse</span> <span class="o">=</span> <span class="n">ParseParams</span><span class="p">(</span><span class="s1">&#39;rad.in&#39;</span><span class="p">,</span> <span class="s1">&#39;rad.lat&#39;</span><span class="p">)</span>
    <span class="n">aw0</span> <span class="o">=</span> <span class="n">testParse</span><span class="o">.</span><span class="n">getUndulatorParameter</span><span class="p">()</span>
    <span class="n">xlamd</span> <span class="o">=</span> <span class="n">testParse</span><span class="o">.</span><span class="n">getUndulatorPeriod</span><span class="p">()</span>
    <span class="n">unitlength</span> <span class="o">=</span> <span class="n">testParse</span><span class="o">.</span><span class="n">getUndulatorUnitlength</span><span class="p">()</span>
    <span class="n">xlamds</span> <span class="o">=</span> <span class="n">testParse</span><span class="o">.</span><span class="n">getFELwavelength</span><span class="p">()</span>
    <span class="n">gamma0</span> <span class="o">=</span> <span class="n">testParse</span><span class="o">.</span><span class="n">getElectronGamma</span><span class="p">()</span>
    <span class="n">emitx</span> <span class="o">=</span> <span class="n">testParse</span><span class="o">.</span><span class="n">getElectronEmitx</span><span class="p">()</span>
    <span class="n">imagl</span> <span class="o">=</span> <span class="n">testParse</span><span class="o">.</span><span class="n">getChicaneMagnetLength</span><span class="p">()</span>
    <span class="n">idril</span> <span class="o">=</span> <span class="n">testParse</span><span class="o">.</span><span class="n">getChicaneDriftLength</span><span class="p">()</span>
    <span class="n">ibfield</span> <span class="o">=</span> <span class="n">testParse</span><span class="o">.</span><span class="n">getChicaneMagnetField</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    print(&quot;aw0    = %.3f&quot; % aw0   )</span>
<span class="sd">    print(&quot;xlamd  = %.3f&quot; % xlamd )</span>
<span class="sd">    print(&quot;xlamds = %.3e&quot; % xlamds)</span>
<span class="sd">    print(&quot;gamma0 = %.3f&quot; % gamma0)</span>
<span class="sd">    print(&quot;emitx  = %.3e&quot; % emitx )</span>
<span class="sd">    print(&quot;imagl  = %.3f&quot; % imagl )</span>
<span class="sd">    print(&quot;idril  = %.3f&quot; % idril )</span>
<span class="sd">    print(&quot;ibfield= %.3f&quot; % ibfield)</span>
<span class="sd">    print(&quot;unit   = %.3f&quot; % unitlength)</span>
<span class="sd">    print parseLattice(&#39;fullat.hghg&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">qf</span><span class="p">,</span> <span class="n">qd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>

    <span class="n">testMatch</span> <span class="o">=</span> <span class="n">BeamMatch</span><span class="p">(</span><span class="s1">&#39;mod.in&#39;</span><span class="p">,</span> <span class="s1">&#39;rad.in&#39;</span><span class="p">,</span> <span class="s1">&#39;mod.lat&#39;</span><span class="p">,</span> <span class="s1">&#39;rad.lat&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;newmod.in&#39;</span><span class="p">,</span> <span class="s1">&#39;newrad.in&#39;</span><span class="p">,</span> <span class="s1">&#39;newrad.lat&#39;</span><span class="p">,</span> <span class="n">qf</span><span class="p">,</span> <span class="n">qd</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">testMatch</span><span class="o">.</span><span class="n">matchCalculate</span><span class="p">():</span>
        <span class="n">testMatch</span><span class="o">.</span><span class="n">matchPerform</span><span class="p">()</span>
        <span class="c1">#testMatch.matchPrintout()</span>
        <span class="n">fel</span> <span class="o">=</span> <span class="n">FELSimulator</span><span class="p">()</span>
        <span class="n">fel</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="n">fel</span><span class="o">.</span><span class="n">postProcess</span><span class="p">()</span>
        <span class="k">print</span> <span class="n">fel</span><span class="o">.</span><span class="n">getMaxPower</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">test</span><span class="p">()</span>
</pre></div>
</div>
<dl class="docutils">
<dt>The FEL physics related files:</dt>
<dd><ul class="first last simple">
<li><a class="reference download internal" href="../../_downloads/mod.in" download=""><code class="xref download docutils literal"><span class="pre">Modulator</span> <span class="pre">input</span> <span class="pre">file</span></code></a></li>
<li><a class="reference download internal" href="../../_downloads/mod.lat" download=""><code class="xref download docutils literal"><span class="pre">Modulator</span> <span class="pre">lattice</span> <span class="pre">file</span></code></a></li>
<li><a class="reference download internal" href="../../_downloads/mod.in" download=""><code class="xref download docutils literal"><span class="pre">Radiator</span> <span class="pre">input</span> <span class="pre">file</span></code></a></li>
<li><a class="reference download internal" href="../../_downloads/mod.lat" download=""><code class="xref download docutils literal"><span class="pre">Radiator</span> <span class="pre">lattice</span> <span class="pre">file</span></code></a></li>
<li><a class="reference download internal" href="../../_downloads/fullat.hghg" download=""><code class="xref download docutils literal"><span class="pre">Lattice</span> <span class="pre">configuration</span> <span class="pre">file</span></code></a></li>
</ul>
</dd>
<dt>Wrap it up:</dt>
<dd><ul class="first last">
<li><p class="first">Create <code class="docutils literal"><span class="pre">ParseParams()</span></code> instance to get needed parameter values;</p>
</li>
<li><dl class="first docutils">
<dt>Create <code class="docutils literal"><span class="pre">BeamMatch()</span></code> instance to resolve matching issues:</dt>
<dd><ul class="first last simple">
<li>Invoke <code class="docutils literal"><span class="pre">mathCalculate()</span></code> to figure out the Twiss parameter
required;</li>
<li><code class="docutils literal"><span class="pre">run()</span></code> and <code class="docutils literal"><span class="pre">postProcess()</span></code> methods of <code class="docutils literal"><span class="pre">FELSimulator</span></code>
to produce the simulation and get output files;</li>
<li><code class="docutils literal"><span class="pre">genesis</span> <span class="pre">1.3</span></code> is used to handle the FEL simulation.</li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
<dt>Tips about the post processing with the <code class="docutils literal"><span class="pre">genesis</span> <span class="pre">1.3</span></code> generated files:</dt>
<dd><ul class="first last">
<li><p class="first">For steady-stat (single slice) simulation mode, use this shell script
(name: <code class="docutils literal"><span class="pre">getssdata.sh</span></code>)to get well-formated output data by columns:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">tempdir</span><span class="o">=</span>/tmp/tmp.<span class="nv">$$</span>
<span class="nv">outfile</span><span class="o">=</span><span class="s2">&quot;rad.out&quot;</span>
awk <span class="s1">&#39;/z\[m\]/,/current/&#39;</span> <span class="si">${</span><span class="nv">outfile</span><span class="si">}</span> <span class="p">|</span> tr -d <span class="s1">&#39;\r&#39;</span> <span class="p">|</span> sed <span class="s2">&quot;/^</span>$<span class="s2">/d;/[*,=,cur]/d;s/^[ ,\t]*//;1s/^/#/&quot;</span> &gt; <span class="si">${</span><span class="nv">tempdir</span><span class="si">}</span>/zaq
awk <span class="s1">&#39;/current/,/\$/&#39;</span> <span class="si">${</span><span class="nv">outfile</span><span class="si">}</span> <span class="p">|</span> tr -d <span class="s1">&#39;\r&#39;</span> <span class="p">|</span> sed <span class="s2">&quot;1d;/^</span>$<span class="s2">/d;s/^[ ,\t]*//&quot;</span> &gt; <span class="si">${</span><span class="nv">tempdir</span><span class="si">}</span>/outdata
paste <span class="si">${</span><span class="nv">tempdir</span><span class="si">}</span>/zaq <span class="si">${</span><span class="nv">tempdir</span><span class="si">}</span>/outdata
</pre></div>
</div>
</li>
<li><p class="first">Show the beam size variation along undulator:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>getssdata.sh rad.out <span class="p">|</span> awk <span class="s1">&#39;{print $1,$13}&#39;</span> <span class="p">|</span> graph -T X -C
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/xplot.png"><img alt="../../_images/xplot.png" src="../../_images/xplot.png" style="width: 400px;" /></a>
</li>
</ul>
</dd>
</dl>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">Integrate FEL physics manipulation, like Twiss matching into
online modeling framework, and develop online-modeling optimization
modules.</p>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="demo4.html" class="btn btn-neutral float-right" title="Example 4" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="demo2.html" class="btn btn-neutral" title="Example 2" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Tong Zhang.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.3.6',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>